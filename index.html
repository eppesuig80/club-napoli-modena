<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Club Napoli Partenopei – Gestione Soci &amp; Trasferte</title>
<style>
    :root{
      --napoli-1:#003DA5;
      --napoli-2:#00ADEF;
      --rosa:#f0a6c1;
      --bg1:#15264a;
      --bg2:#0d1f3d;
      --card:#0f1e39;
      --line:#2a3f67;
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%); color:#e5e7eb}
    .wrap{max-width:min(1600px,98vw);margin:auto;padding:22px}
    header{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    #clubLogo{width:90px;height:90px;object-fit:contain;border-radius:50%;background:#0b1b36;padding:4px;box-shadow:0 0 0 3px #0b1b36,0 8px 24px rgba(0,0,0,.35)}
    .titles{display:flex;flex-direction:column;gap:6px}
    .title{font-size:clamp(26px,4.8vw,40px);font-weight:800;letter-spacing:.5px;color:white}
    .subtitle{font-size:clamp(16px,2.6vw,20px);color:#cfe9ff}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0b1b36;color:#dbeafe;padding:12px 16px;border-radius:14px;cursor:pointer;font-size:16px}
    .btn:hover{background:#0e254f}
    .btn.primary{background:linear-gradient(90deg,var(--napoli-1),var(--napoli-2)); border-color:transparent}
    .btn.ghost{background:transparent;border-color:#324164}
    .btn.warn{background:#382a00;border-color:#876400;color:#fef08a}
    .btn.danger{background:#3b0b0b;border-color:#7f1d1d;color:#fecaca}
    .section{margin-top:18px;background:rgba(255,255,255,0.035);border:1px solid #24304d;border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .section h2{margin:0;padding:16px 18px;border-bottom:1px solid #23304e;color:#dbeafe;font-size:20px}
    .content{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:14px;color:#93c5fd}
    input,select{height:46px;border-radius:12px;border:1px solid #294064;background:#0c1c39;color:#e5e7eb;padding:0 12px;font-size:16px}
    input[type="date"]{color-scheme:dark}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .chip{border-radius:999px;padding:4px 12px;font-size:13px;border:1px solid #1f2a44}
    .chip.azzurro{background:#042649;color:#bfe6ff}
    .chip.rosa{background:#3a1431;color:#ffd0ec}
    .lists{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:18px;color:#c7d2fe}
    .card .body{padding:12px}
    .item{display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center;padding:14px;border-bottom:1px dashed var(--line);border-radius:12px}
    .item:last-child{border-bottom:none}
    .item.sex-m{background:linear-gradient(90deg, rgba(0,173,239,.42), rgba(0,173,239,.20)); box-shadow: inset 6px 0 rgba(0,173,239,.70);}
    .item.sex-f{background:linear-gradient(90deg, rgba(240,166,193,.44), rgba(240,166,193,.22)); box-shadow: inset 6px 0 rgba(240,166,193,.70);}
    .name{font-weight:900;font-size:22px;letter-spacing:.25px}
    .meta{font-size:18px;color:#d2def8}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .iconbtn{border:1px solid #24304d;border-radius:12px;background:#0b1b36;color:#e5e7eb;padding:9px 12px;cursor:pointer;font-size:18px}
    .iconbtn:hover{background:#0e254f}
    .searchWrap{position:relative}
    .search{width:min(780px,100%);height:46px;border-radius:12px;border:1px solid #294064;background:#0c1c39;color:#e5e7eb;padding:0 12px;font-size:16px}
    .results{position:absolute;top:52px;left:0;right:0;background:#0b1b36;border:1px solid #24304d;border-radius:12px;max-height:260px;overflow:auto;display:none;z-index:10}
    .result{padding:10px 12px;border-bottom:1px dashed #1f2a44;cursor:pointer}
    .result:last-child{border-bottom:none}
    .hide{display:none}
    small.help{color:#9db8ff}
    .archiveBlock{padding:10px;border:1px dashed #324164;border-radius:12px;margin-top:10px}
    .muted{color:#93a3bf}
    footer{opacity:.7;padding:24px;text-align:center;font-size:12px}
    .number{color:#a5b4fc}
    /* Sezioni più chiare per distinguere */
    #cardTrasferte{ background:#143259; border-color:#3b5f8f; }
    #cardAccomp{ background:#184270; border-color:#4a74a6; }
    #cardTrasferte .meta{ color:#e2ecff }
    #cardAccomp .meta{ color:#f0f6ff }
    #cardTrasferte .item.sex-m{background:linear-gradient(90deg, rgba(0,173,239,.55), rgba(0,173,239,.30)); box-shadow: inset 6px 0 rgba(0,173,239,.85);}
    #cardTrasferte .item.sex-f{background:linear-gradient(90deg, rgba(240,166,193,.57), rgba(240,166,193,.30)); box-shadow: inset 6px 0 rgba(240,166,193,.85);}
    #cardAccomp .item.sex-m{background:linear-gradient(90deg, rgba(0,173,239,.70), rgba(0,173,239,.40)); box-shadow: inset 6px 0 rgba(0,173,239,.95);}
    #cardAccomp .item.sex-f{background:linear-gradient(90deg, rgba(240,166,193,.72), rgba(240,166,193,.42)); box-shadow: inset 6px 0 rgba(240,166,193,.95);}
    #cardTrasferte .item.sex-m .name, #cardAccomp .item.sex-m .name{ color:#cfe9ff }
    /* Evidenzia riga selezionata in Trasferte */
    #cardTrasferte .item.hl{background:linear-gradient(90deg, rgba(16,185,129,.35), rgba(16,185,129,.18)); box-shadow: inset 6px 0 rgba(16,185,129,.9);}
    #cardTrasferte .item.hl .name{ color:#d1fae5; text-decoration: underline; text-decoration-thickness:3px; text-underline-offset:3px;}

    #cardTrasferte .item.sex-f .name, #cardAccomp .item.sex-f .name{ color:#ffd8ee }
    @media (max-width:640px){
      .item{grid-template-columns:1fr;}
      .actions{justify-content:flex-start}
    }
  </style>

<style id="cnp_print_orientation_auto">@media print { @page { size: auto; } }</style>
</head>
<body>
<div class="wrap">
<header>
<img alt="Logo Club" id="clubLogo"/>
<div class="titles">
<div class="title" contenteditable="" id="clubTitle">CLUB NAPOLI PARTENPEI</div>
<div class="subtitle"><span contenteditable="" id="clubSubtitle">Inserimento Dati</span></div>
</div>
<div class="toolbar">
<label class="btn ghost" for="logoFile">Carica Logo</label>
<input accept="image/*" class="hide" id="logoFile" type="file"/>
<button class="btn" id="btnExport">Esporta JSON</button>
<button class="btn" id="btnExportSociPdf">Esporta Soci (PDF)</button>
<label class="btn warn" for="importFile">Importa JSON</label>
<input accept="application/json" class="hide" id="importFile" type="file"/>
<button class="btn danger" id="btnReset">Svuota tutto</button>
</div>
</header>
<div class="section" id="formSociSection">
<h2>Modulo iscrizione – Soci</h2>
<div class="content">
<div class="grid" style="grid-template-columns:repeat(12,1fr)">
<div class="field" style="grid-column:span 3">
<label>Nome</label>
<input id="s_nome" placeholder="Nome"/>
</div>
<div class="field" style="grid-column:span 3">
<label>Cognome</label>
<input id="s_cognome" placeholder="Cognome"/>
</div>
<div class="field" style="grid-column:span 2">
<label>Luogo di nascita</label>
<input id="s_luogo" placeholder="Comune"/>
</div>
<div class="field" style="grid-column:span 1">
<label>PRO</label>
<input id="s_proNasc" inputmode="latin" list="provSigle" maxlength="3" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);" pattern="^[A-Za-z]{2,3}$" placeholder="PR" style="text-transform: uppercase" title="Inserisci la sigla della provincia (2–3 lettere, es. NA o ZRH)"/><!-- MOD: Provincia PR normalized 2–3 letters -->
</div>
<div class="field" style="grid-column:span 2">
<label>Data</label>
<input id="s_data" type="date"/>
</div>
<div class="field" style="grid-column:span 2">
<label>Residenza</label>
<input id="s_res" placeholder="Comune"/>
</div>
<div class="field" style="grid-column:span 1">
<label>PRO</label>
<input id="s_proRes" inputmode="latin" list="provSigle" maxlength="3" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);" pattern="^[A-Za-z]{2,3}$" placeholder="PR" style="text-transform: uppercase" title="Inserisci la sigla della provincia (2–3 lettere, es. NA o ZRH)"/><!-- MOD: Provincia PR normalized 2–3 letters -->
</div>
<div class="field" style="grid-column:span 2">
<label>N° Tessera</label>
<input id="s_tess" placeholder="0000"/>
</div>
<div class="field" style="grid-column:span 3">
<label>CF</label>
<input id="s_cf" placeholder="Codice Fiscale"/>
</div>
<div class="field" style="grid-column:span 2">
<label>Sesso</label>
<select id="s_sesso">
<option value="M">M</option>
<option value="F">F</option>
</select>
</div>
<div class="field" style="grid-column:span 2">
<label>Colore (auto)</label>
<div class="row">
<span class="chip azzurro" id="s_colore">Azzurro</span>
</div>
</div>
<div class="field" style="grid-column:span 12">
<div class="row">
<button class="btn primary" id="btnAddSocio">Aggiungi / Salva</button>
<button class="btn ghost" id="btnClearSocio">Pulisci</button>
<button class="btn warn" id="btnBusSocio" title="Aggiungi anche a Trasferte">Bus 🚌</button>
<span class="chip" id="editFlag" style="display:none">Modifica in corso…</span>
</div>
</div>
</div>
</div>
</div>
<div class="row" style="margin-top:14px;align-items:flex-end">
<div class="searchWrap">
<label class="muted" for="search">Cerca socio (min 3 lettere)</label>
<input class="search" id="search" placeholder="Cerca per cognome/nome/CF"/>
<div class="results" id="searchResults"></div>
</div>
</div>
<div class="lists" style="margin-top:14px">
<div class="card">
<div class="body">
<div class="row" style="justify-content:space-between;margin-bottom:10px">
<small class="muted">Mostra/Nascondi soci</small>
<button class="btn ghost" id="toggleSoci">Mostra / Nascondi</button>
</div>
<div id="listSoci"></div>
</div>
</div>
<div class="card" id="cardTrasferte">
<div class="body">
<div class="row" style="justify-content:space-between;margin-bottom:8px">
<label class="muted" for="trasfertaNome" style="min-width:120px">Nome lista</label>
<input id="trasfertaNome" placeholder="Es. Trasferta Bologna 20/10/2025" style="flex:1;min-width:240px"/>
</div>
<div class="row" style="justify-content:space-between;margin:6px 0 10px 0">
<small class="muted">Mostra/Nascondi trasferte</small>
<button class="btn ghost" id="toggleTrasferte">Mostra / Nascondi</button>
</div>
<div id="listTrasferte"></div>
<div class="archiveBlock">
<div class="row" style="justify-content:space-between;align-items:center">
<small class="muted">Puoi archiviare l'intera lista come "Trasferta Conclusa" e ripartire da zero.</small>
<div class="row" style="gap:8px">
<button class="btn" id="btnPrintTrasferte" title="Stampa lista">🖨️</button>
<button class="btn warn" id="btnArchiveTrasferta">Archivia Trasferta</button>
</div>
</div>
</div>
</div>
</div>
<div class="card" id="cardAccomp">
<h3>Archivio Accompagnatori</h3>
<div class="body">
<div class="row" style="justify-content:space-between;margin-bottom:10px">
<small class="muted">Mostra/Nascondi accompagnatori</small>
<button class="btn ghost" id="toggleAccomp">Mostra / Nascondi</button>
</div>
<div id="listAccomp"></div>
</div>
</div>
</div>
<div class="section" style="margin-top:18px">
<h2>Archivio – Trasferte Concluse</h2>
<div class="content" id="archivioTrasferte">
<div class="row" style="justify-content:space-between;margin-bottom:10px">
<small class="muted">Mostra/Nascondi elenco</small>
<button class="btn ghost" id="toggleArchivio">Mostra / Nascondi</button>
</div>
<div class="hide" id="archivioContainer"></div>
</div>
</div>
<div class="section" style="margin-top:18px">
<h2>Modulo iscrizione – Accompagnatori</h2>
<div class="content">
<div class="row" style="justify-content:space-between;margin-bottom:10px">
<small class="muted">Mostra/Nascondi modulo</small>
<button class="btn ghost" id="toggleFormAccomp">Mostra / Nascondi</button>
</div>
<div class="grid" id="formAccompGrid" style="grid-template-columns:repeat(12,1fr)">
<div class="field" style="grid-column:span 3">
<label>Nome</label>
<input id="a_nome" placeholder="Nome"/>
</div>
<div class="field" style="grid-column:span 3">
<label>Cognome</label>
<input id="a_cognome" placeholder="Cognome"/>
</div>
<div class="field" style="grid-column:span 2">
<label>Luogo</label>
<input id="a_luogo" placeholder="Comune"/>
</div>
<div class="field" style="grid-column:span 1">
<label>PRO</label>
<input id="a_proNasc" inputmode="latin" list="provSigle" maxlength="3" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);" pattern="^[A-Za-z]{2,3}$" placeholder="PR" style="text-transform: uppercase" title="Inserisci la sigla della provincia (2–3 lettere, es. NA o ZRH)"/><!-- MOD: Provincia PR normalized 2–3 letters -->
</div>
<div class="field" style="grid-column:span 2">
<label>Data</label>
<input id="a_data" type="date"/>
</div>
<div class="field" style="grid-column:span 2">
<label>Residenza</label>
<input id="a_res" placeholder="Comune"/>
</div>
<div class="field" style="grid-column:span 1">
<label>PRO</label>
<input id="a_proRes" inputmode="latin" list="provSigle" maxlength="3" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);" pattern="^[A-Za-z]{2,3}$" placeholder="PR" style="text-transform: uppercase" title="Inserisci la sigla della provincia (2–3 lettere, es. NA o ZRH)"/><!-- MOD: Provincia PR normalized 2–3 letters -->
</div>
<div class="field" style="grid-column:span 2">
<label>N° Tessera</label>
<input id="a_tess" placeholder="0000"/>
</div>
<div class="field" style="grid-column:span 3">
<label>CF</label>
<input id="a_cf" placeholder="Codice Fiscale"/>
</div>
<div class="field" style="grid-column:span 2">
<label>Sesso</label>
<select id="a_sesso">
<option value="M">M</option>
<option value="F">F</option>
</select>
</div>
<div class="field" style="grid-column:span 2">
<label>Colore (auto)</label>
<div class="row">
<span class="chip azzurro" id="a_colore">Azzurro</span>
</div>
</div>
<div class="field" style="grid-column:span 12">
<div class="row">
<button class="btn primary" id="btnAddAccomp">Aggiungi / Salva</button>
<button class="btn ghost" id="btnClearAccomp">Pulisci</button>
<span class="chip" id="editFlagA" style="display:none">Modifica in corso…</span>
</div>
</div>
</div>
</div>
</div>
<footer>© <span id="year"></span> – Gestione soci, accompagnatori e trasferte · Stile SSC Napoli.
    </footer>
</div>
<script>
(function(){
  const byId = id => document.getElementById(id);
  const storeKey = 'club-napoli-db-v1';
  const titleKey = 'club-napoli-titles';
  const logoKey = 'club-napoli-logo';
  const trasfTitleKey = 'trasferte-title';
  const accompVisibleKey = 'accomp-visible';
  const sociVisibleKey = 'soci-visible';
  const trasferteVisibleKey = 'trasferte-visible';
  const formAccompVisibleKey = 'form-accomp-visible';

  const state = { soci: [], accomp: [], trasferte: [], archivio: [] };

  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const save = () => localStorage.setItem(storeKey, JSON.stringify(state));
  const load = () => { const raw = localStorage.getItem(storeKey); if(raw){ try{ Object.assign(state, JSON.parse(raw)); }catch(e){} } };
  const formatName = o => `${(o.cognome||'').trim().toUpperCase()} ${(o.nome||'').trim()}`.trim();
  const sexColor = s => s==='F' ? {txt:'Rosa', cls:'rosa'} : {txt:'Azzurro', cls:'azzurro'};

  function loadTitles(){ const t = JSON.parse(localStorage.getItem(titleKey) || '{}'); if(t.title) byId('clubTitle').textContent=t.title; if(t.subtitle) byId('clubSubtitle').textContent=t.subtitle; }
  function saveTitles(){ localStorage.setItem(titleKey, JSON.stringify({title:byId('clubTitle').textContent.trim(), subtitle:byId('clubSubtitle').textContent.trim()})); }
  function loadLogo(){ const data = localStorage.getItem(logoKey); if(data){ byId('clubLogo').src=data; } }
  function handleLogoFile(file){ const r=new FileReader(); r.onload=e=>{ localStorage.setItem(logoKey,e.target.result); loadLogo(); }; r.readAsDataURL(file); }

  load(); loadTitles(); loadLogo();
  byId('year').textContent = new Date().getFullYear();
  ['clubTitle','clubSubtitle'].forEach(id=> byId(id).addEventListener('input', debounce(saveTitles,300)) );
  byId('logoFile').addEventListener('change', e=>{ const f = e.target.files?.[0]; if(f) handleLogoFile(f); e.target.value=''; });

  const S={nome:byId('s_nome'),cognome:byId('s_cognome'),luogo:byId('s_luogo'),proNasc:byId('s_proNasc'),data:byId('s_data'),res:byId('s_res'),proRes:byId('s_proRes'),tess:byId('s_tess'),cf:byId('s_cf'),sesso:byId('s_sesso'),colore:byId('s_colore'),editFlag:byId('editFlag')};
  const A={nome:byId('a_nome'),cognome:byId('a_cognome'),luogo:byId('a_luogo'),proNasc:byId('a_proNasc'),data:byId('a_data'),res:byId('a_res'),proRes:byId('a_proRes'),tess:byId('a_tess'),cf:byId('a_cf'),sesso:byId('a_sesso'),colore:byId('a_colore'),editFlag:byId('editFlagA')};
  function updateColorChip(selectEl, chipEl){ const info=sexColor(selectEl.value); chipEl.textContent=info.txt; chipEl.className=`chip ${info.cls}`; }
  S.sesso.addEventListener('change',()=>updateColorChip(S.sesso,S.colore)); A.sesso.addEventListener('change',()=>updateColorChip(A.sesso,A.colore)); updateColorChip(S.sesso,S.colore); updateColorChip(A.sesso,A.colore);

  let editingSocioId=null, editingAccompId=null;

  byId('btnAddSocio').addEventListener('click', ()=>{
    const o={nome:S.nome.value.trim(),cognome:S.cognome.value.trim(),luogo:S.luogo.value.trim(),proNasc:S.proNasc.value.trim().toUpperCase(),data:S.data.value,res:S.res.value.trim(),proRes:S.proRes.value.trim().toUpperCase(),tess:S.tess.value.trim(),cf:S.cf.value.trim().toUpperCase(),sesso:S.sesso.value,colore:sexColor(S.sesso.value).txt};
    if(!o.nome||!o.cognome){ alert('Nome e Cognome sono obbligatori'); return; }
    if(editingSocioId){ const i=state.soci.findIndex(x=>x.id===editingSocioId); if(i>-1) state.soci[i]={...state.soci[i],...o}; editingSocioId=null; S.editFlag.style.display='none'; }
    else{ const dup=state.soci.some(x=>x.cognome.toLowerCase()===o.cognome.toLowerCase()&&x.nome.toLowerCase()===o.nome.toLowerCase()&&x.data===o.data); if(dup && !confirm('Sembra già inserito. Aggiungere comunque?')) return; state.soci.push({id:uid(),...o}); }
    state.soci.sort((a,b)=>a.cognome.localeCompare(b.cognome)||a.nome.localeCompare(b.nome)); save(); renderAll(); clearSocio();
  });
  function clearSocio(){ [S.nome,S.cognome,S.luogo,S.proNasc,S.data,S.res,S.proRes,S.tess,S.cf].forEach(x=>x.value=''); S.sesso.value='M'; updateColorChip(S.sesso,S.colore); editingSocioId=null; S.editFlag.style.display='none'; }
  byId('btnClearSocio').addEventListener('click', clearSocio);

  byId('btnAddAccomp').addEventListener('click', ()=>{
    const o={nome:A.nome.value.trim(),cognome:A.cognome.value.trim(),luogo:A.luogo.value.trim(),proNasc:A.proNasc.value.trim().toUpperCase(),data:A.data.value,res:A.res.value.trim(),proRes:A.proRes.value.trim().toUpperCase(),tess:A.tess.value.trim(),cf:A.cf.value.trim().toUpperCase(),sesso:A.sesso.value,colore:sexColor(A.sesso.value).txt};
    if(!o.nome||!o.cognome){ alert('Nome e Cognome sono obbligatori'); return; }
    if(editingAccompId){ const i=state.accomp.findIndex(x=>x.id===editingAccompId); if(i>-1) state.accomp[i]={...state.accomp[i],...o}; editingAccompId=null; A.editFlag.style.display='none'; }
    else{ const dup=state.accomp.some(x=>x.cognome.toLowerCase()===o.cognome.toLowerCase()&&x.nome.toLowerCase()===o.nome.toLowerCase()&&x.data===o.data); if(dup && !confirm('Sembra già inserito. Aggiungere comunque?')) return; state.accomp.push({id:uid(),...o}); }
    state.accomp.sort((a,b)=>a.cognome.localeCompare(b.cognome)||a.nome.localeCompare(b.nome)); save(); renderAll(); clearAccomp();
  });
  function clearAccomp(){ [A.nome,A.cognome,A.luogo,A.proNasc,A.data,A.res,A.proRes,A.tess,A.cf].forEach(x=>x.value=''); A.sesso.value='M'; updateColorChip(A.sesso,A.colore); editingAccompId=null; A.editFlag.style.display='none'; }
  byId('btnClearAccomp').addEventListener('click', clearAccomp);

  // Export/Import
  byId('btnExport').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify({
      state,
      titles:{title:byId('clubTitle').textContent,subtitle:byId('clubSubtitle').textContent},
      logo:localStorage.getItem(logoKey)||null,
      trasferte_title: (byId('trasfertaNome')?.value || '')
    }, null, 2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='club-napoli-export.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  byId('importFile').addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
    r.onload=ev=>{
      try{
        const j=JSON.parse(ev.target.result);
        if(j.state) Object.assign(state,j.state);
        if(j.titles){ byId('clubTitle').textContent=j.titles.title||byId('clubTitle').textContent; byId('clubSubtitle').textContent=j.titles.subtitle||byId('clubSubtitle').textContent; saveTitles(); }
        if(j.logo){ localStorage.setItem(logoKey,j.logo); }
        if(j.trasferte_title){ localStorage.setItem(trasfTitleKey, j.trasferte_title); }
        save(); renderAll(); loadLogo();
        const tf=byId('trasfertaNome'); if(tf){ tf.value = localStorage.getItem(trasfTitleKey) || tf.value; }
      }catch(err){ alert('File non valido'); }
    };
    r.readAsText(f);
    e.target.value='';
  });
  byId('btnReset').addEventListener('click', ()=>{ if(confirm('Sicuro di eliminare TUTTO?')){ localStorage.removeItem(storeKey); localStorage.removeItem(titleKey); localStorage.removeItem(logoKey); localStorage.removeItem(trasfTitleKey); localStorage.removeItem(accompVisibleKey); localStorage.removeItem(formAccompVisibleKey); location.reload(); } });

  // Search
  const search=byId('search'); const searchResults=document.getElementById('searchResults');
  search.addEventListener('input', ()=>{
    const q=search.value.trim().toLowerCase();
    if(q.length<3){ searchResults.style.display='none'; searchResults.innerHTML=''; return; }
    const pool=[...state.soci.map(s=>({...s,_from:'soci'})), ...state.accomp.map(a=>({...a,_from:'accomp'}))];
    const matches=pool.filter(p=>[p.cognome,p.nome,p.cf].some(x=>(x||'').toLowerCase().includes(q))).slice(0,50);
    searchResults.innerHTML=matches.map(p=>`<div class="result" data-id="${p.id}" data-from="${p._from}"><strong>${formatName(p)}</strong> <span class="muted">(${p.cf||'n/d'})</span></div>`).join('');
    searchResults.style.display=matches.length?'block':'none';
  });
  searchResults.addEventListener('click', e=>{
    const row=e.target.closest('.result'); if(!row) return;
    const id=row.dataset.id; const from=row.dataset.from;
    if(from==='soci'){ const s=state.soci.find(x=>x.id===id); fillSocioForm(s); }
    else { const a=state.accomp.find(x=>x.id===id); fillAccompForm(a); }
    searchResults.style.display='none';
  });
  document.addEventListener('click', e=>{ if(!searchResults.contains(e.target) && e.target!==search) searchResults.style.display='none'; });

  function fillSocioForm(s){ if(!s) return; S.nome.value=s.nome||''; S.cognome.value=s.cognome||''; S.luogo.value=s.luogo||''; S.proNasc.value=s.proNasc||''; S.data.value=s.data||''; S.res.value=s.res||''; S.proRes.value=s.proRes||''; S.tess.value=s.tess||''; S.cf.value=s.cf||''; S.sesso.value=s.sesso||'M'; updateColorChip(S.sesso,S.colore); editingSocioId=s.id; S.editFlag.style.display='inline-flex'; window.scrollTo({top:byId('formSociSection').offsetTop-10,behavior:'smooth'}); }
  function fillAccompForm(a){ if(!a) return; A.nome.value=a.nome||''; A.cognome.value=a.cognome||''; A.luogo.value=a.luogo||''; A.proNasc.value=a.proNasc||''; A.data.value=a.data||''; A.res.value=a.res||''; A.proRes.value=a.proRes||''; A.tess.value=a.tess||''; A.cf.value=a.cf||''; A.sesso.value=a.sesso||'M'; updateColorChip(A.sesso,A.colore); editingAccompId=a.id; A.editFlag.style.display='inline-flex'; window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); }

  function rowClassBySex(s){ const v = String(s||'').trim().toUpperCase(); return v==='F' ? 'sex-f' : 'sex-m'; }

  // Format ISO/string to gg/mm/aaaa
  function fmtITDate(d){
    if(!d) return '–';
    const iso = /^(\d{4})-(\d{2})-(\d{2})$/;
    const m1 = d.match(iso);
    if(m1){ return `${m1[3]}/${m1[2]}/${m1[1]}`; }
    const m2 = d.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(m2){
      let [_, a,b,c] = m2; a=a.padStart(2,'0'); b=b.padStart(2,'0'); if(c.length===2){ c = (+c < 50 ? '20':'19')+c; }
      return `${a}/${b}/${c}`;
    }
    return d;
  }


  // Escape HTML for appunti
  function escHtml(s){
    if(s==null) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }


  function renderSoci(){
    const target=byId('listSoci');
    const rows=state.soci.map((s,i)=>{
      return `<div class="item ${rowClassBySex(s.sesso)}" data-id="${s.id}" data-from="soci">
        <div>
          <div class="name"><span class="number">${String(i+1).padStart(3,'0')}</span> · ${formatName(s)}</div>
          <div class="meta">${s.luogo||'–'} (${s.proNasc||'–'}) · ${fmtITDate(s.data)} · Res: ${s.res||'–'} (${s.proRes||'–'}) · Tess: ${s.tess||'–'} · CF: ${s.cf||'–'}</div>
        </div>
        <div class="actions">
          <button class="iconbtn" title="Aggiungi a Trasferte" data-act="bus">🚌</button>
          <button class="iconbtn" title="Modifica" data-act="edit">✏️</button>
          <button class="iconbtn" title="Elimina" data-act="del">🗑️</button>
        </div>
      </div>`;
    }).join('');
    target.innerHTML = rows || '<div class="muted">Nessun socio inserito.</div>';
  }

  function renderAccomp(){
    const target=byId('listAccomp');
    const rows=state.accomp.map((a,i)=>{
      return `<div class="item ${rowClassBySex(a.sesso)}" data-id="${a.id}" data-from="accomp">
        <div>
          <div class="name"><span class="number">${String(i+1).padStart(3,'0')}</span> · ${formatName(a)}</div>
          <div class="meta">${a.luogo||'–'} (${a.proNasc||'–'}) · ${fmtITDate(a.data)} · Res: ${a.res||'–'} (${a.proRes||'–'}) · Tess: ${a.tess||'–'} · CF: ${a.cf||'–'}</div>
        </div>
        <div class="actions">
          <button class="iconbtn" title="Aggiungi a Trasferte" data-act="bus">🚌</button>
          <button class="iconbtn" title="Modifica" data-act="edit">✏️</button>
          <button class="iconbtn" title="Elimina" data-act="del">🗑️</button>
        </div>
      </div>`;
    }).join('');
    target.innerHTML = rows || '<div class="muted">Nessun accompagnatore inserito.';
  }

  function renderTrasferte(){
    const target=byId('listTrasferte');
    const rows=state.trasferte.map((t,i)=>{
      const src=t.from==='soci'? state.soci : state.accomp;
      const p=src.find(x=>x.id===t.idRef);
      if(!p) return '';
      return `<div class="item ${t.hl?'hl':''}" data-id="${p.id}" data-from="${t.from}">
        <div>
          <div class="name ${t.note ? 'note-active' : ''}"><span class="number">${String(i+1).padStart(3,'0')}</span> · ${formatName(p)}${t.note ? ` <span class="appunto">${escHtml(t.note)}</span>` : ``}</div>
          <div class="meta">${p.luogo||'–'} (${p.proNasc||'–'}) · ${fmtITDate(p.data)} · Res: ${p.res||'–'} (${p.proRes||'–'}) · Tess: ${p.tess||'–'} · CF: ${p.cf||'–'}</div>
        </div>
        <div class="actions">
          <button class="iconbtn" title="Evidenzia" data-act="hl">🖍️</button>
          <button class="iconbtn" title="Appunto" data-act="note">📝</button>
          <button class="iconbtn" title="Posizione" data-act="pos">📍</button>
          <button class="iconbtn" title="Modifica" data-act="edit">✏️</button>
          <button class="iconbtn" title="Elimina dalla Trasferta" data-act="del">🗑️</button>
        </div>
      </div>`;
    }).join('');
    target.innerHTML = rows || '<div class="muted">Nessuno in lista Trasferte.</div>';
  }

  function renderArchivio(){
    const box=byId('archivioContainer');
    if(!state.archivio.length){ box.innerHTML='<div class="muted">Nessuna trasferta archiviata.</div>'; return; }
    box.innerHTML=state.archivio.map(entry=>{
      const lines=entry.elenco.map((t,i)=>{
        const src=t.from==='soci'? state.soci : state.accomp;
        const p=(src.find(x=>x.id===t.idRef) || t.snapshot);
        const label=p ? formatName(p) : `ID ${t.idRef}`;
        return `<div class="result"><span class="number">${String(i+1).padStart(3,'0')}</span> · ${label} <span class="muted">(CF: ${(p&&p.cf)||'–'})</span></div>`
      }).join('');
      return `<div class="card" style="margin-bottom:10px"><h3>${entry.titolo}</h3><div class="body">${lines||'<div class="muted">(vuota)</div>'}</div></div>`
    }).join('');
  }

  function renderAll(){ 
    const tf=byId('trasfertaNome'); if(tf && !tf.value){ tf.value = localStorage.getItem(trasfTitleKey) || ''; tf.addEventListener('input', debounce(()=>{ localStorage.setItem(trasfTitleKey, tf.value.trim()); }, 300)); }
    renderSoci(); renderAccomp(); renderTrasferte(); renderArchivio();
    // Init soci visibility
    const sociBox = document.getElementById('listSoci');
    const sociBtn = document.getElementById('toggleSoci');
    const sVis = (localStorage.getItem(sociVisibleKey) ?? '1') === '1';
    sociBox.classList.toggle('hide', !sVis);
    if(sociBtn){ sociBtn.textContent = sVis ? 'Nascondi' : 'Mostra'; sociBtn.addEventListener('click', ()=>{ const curHidden = sociBox.classList.toggle('hide'); const nowVis = !curHidden; localStorage.setItem(sociVisibleKey, nowVis ? '1':'0'); sociBtn.textContent = nowVis ? 'Nascondi' : 'Mostra'; }); }

    // Init trasferte visibility
    const trasfBox = document.getElementById('listTrasferte');
    const trasfBtn = document.getElementById('toggleTrasferte');
    const tVis = (localStorage.getItem(trasferteVisibleKey) ?? '1') === '1';
    trasfBox.classList.toggle('hide', !tVis);
    if(trasfBtn){ trasfBtn.textContent = tVis ? 'Nascondi' : 'Mostra'; trasfBtn.addEventListener('click', ()=>{ const curHidden = trasfBox.classList.toggle('hide'); const nowVis = !curHidden; localStorage.setItem(trasferteVisibleKey, nowVis ? '1':'0'); trasfBtn.textContent = nowVis ? 'Nascondi' : 'Mostra'; }); }

    // Init Modulo accompagnatori visibility
    const formBox = document.getElementById('formAccompGrid');
    const formBtn = document.getElementById('toggleFormAccomp');
    if(formBox && formBtn){
      const fVis = (localStorage.getItem(formAccompVisibleKey) ?? '1') === '1';
      formBox.classList.toggle('hide', !fVis);
      formBtn.textContent = fVis ? 'Nascondi' : 'Mostra';
      formBtn.addEventListener('click', ()=>{ const curHidden = formBox.classList.toggle('hide'); const nowVis = !curHidden; localStorage.setItem(formAccompVisibleKey, nowVis ? '1':'0'); formBtn.textContent = nowVis ? 'Nascondi' : 'Mostra'; });
    }
    // Init accomp visibility
    const accompBox = document.getElementById('listAccomp');
    const accompBtn = document.getElementById('toggleAccomp');
    const vis = (localStorage.getItem(accompVisibleKey) ?? '1') === '1';
    accompBox.classList.toggle('hide', !vis);
    if(accompBtn){ accompBtn.textContent = vis ? 'Nascondi' : 'Mostra'; accompBtn.addEventListener('click', ()=>{ const curHidden = accompBox.classList.toggle('hide'); const nowVis = !curHidden; localStorage.setItem(accompVisibleKey, nowVis ? '1':'0'); accompBtn.textContent = nowVis ? 'Nascondi' : 'Mostra'; }); }
  }
  renderAll();

  function handleListClick(containerId, handler){
    document.getElementById(containerId).addEventListener('click', e=>{
      const actBtn=e.target.closest('[data-act]'); const row=e.target.closest('.item'); if(!row||!actBtn) return;
      const id=row.dataset.id; const from=row.dataset.from; handler(actBtn.dataset.act,id,from,row,e);
    });
  }

  handleListClick('listSoci', (act,id,from)=>{
    const i=state.soci.findIndex(x=>x.id===id); if(i===-1) return; const s=state.soci[i];
    if(act==='bus'){ if(state.trasferte.some(t=>t.idRef===id)){ alert('Già presente in Trasferte'); return; } state.trasferte.push({idRef:id,from:'soci'}); save(); renderTrasferte(); }
    if(act==='edit'){ fillSocioForm(s); }
    if(act==='del'){ if(confirm('Eliminare questo socio?')){ state.trasferte=state.trasferte.filter(t=>t.idRef!==id); state.soci.splice(i,1); save(); renderAll(); } }
  });

  handleListClick('listAccomp', (act,id,from)=>{
    const i=state.accomp.findIndex(x=>x.id===id); if(i===-1) return; const a=state.accomp[i];
    if(act==='bus'){ if(state.trasferte.some(t=>t.idRef===id)){ alert('Già presente in Trasferte'); return; } state.trasferte.push({idRef:id,from:'accomp'}); save(); renderTrasferte(); }
    if(act==='edit'){ fillAccompForm(a); }
    if(act==='del'){ if(confirm('Eliminare questo accompagnatore?')){ state.trasferte=state.trasferte.filter(t=>t.idRef!==id); state.accomp.splice(i,1); save(); renderAll(); } }
  });

  handleListClick('listTrasferte', (act,id,from)=>{
    if(act==='edit'){ if(from==='soci'){ const s=state.soci.find(x=>x.id===id); fillSocioForm(s); } else { const a=state.accomp.find(x=>x.id===id); fillAccompForm(a); } }
    if(act==='del'){ state.trasferte=state.trasferte.filter(t=>!(t.idRef===id&&t.from===from)); save(); renderTrasferte(); }
    if(act==='hl'){ const idx=state.trasferte.findIndex(t=>t.idRef===id&&t.from===from); if(idx>-1){ state.trasferte[idx].hl = !state.trasferte[idx].hl; save(); renderTrasferte(); } }

    if(act==='note'){
      const idx = state.trasferte.findIndex(t=>t.idRef===id&&t.from===from);
      if(idx>-1){
        const cur = state.trasferte[idx];
        const val = prompt('Scrivi un appunto (lascia vuoto per rimuovere):', cur.note || '');
        if(val===null) return;
        const note = String(val).trim();
        if(note){ cur.note = note; } else { delete cur.note; }
        save(); renderTrasferte();
      }
    }
        
    if(act==='pos'){ const cur=state.trasferte.findIndex(t=>t.idRef===id&&t.from===from); if(cur>-1){ const max=state.trasferte.length; let val=prompt(`Nuova posizione (1 - ${max})`, String(cur+1)); if(val!==null){ let pos=parseInt(val,10); if(!isNaN(pos)){ pos=Math.max(1,Math.min(pos,max)); const [it]=state.trasferte.splice(cur,1); state.trasferte.splice(pos-1,0,it); save(); renderTrasferte(); } else { alert('Posizione non valida'); } } } }
  });


  // Esporta l'intera lista Soci in PDF (stampa -> Salva come PDF)
  function exportSociPdf(){
    if(!state.soci.length){ alert('Nessun socio inserito.'); return; }
    let perPage = prompt('Quanti nominativi per pagina?', '25');
    if(perPage===null) return;
    perPage = parseInt(perPage, 10);
    if(isNaN(perPage) || perPage<=0){ alert('Valore non valido'); return; }

    const entries = state.soci.map((s,i)=>({ index:i+1, ...s }));

    const title = document.getElementById('clubTitle').textContent.trim() || 'CLUB NAPOLI PARTENPEI';
    const subtitle = document.getElementById('clubSubtitle').textContent.trim() || 'Elenco Soci';
    const logo = localStorage.getItem('club-napoli-logo');

    const pages = [];
    for(let i=0;i<entries.length;i+=perPage){
      pages.push(entries.slice(i, i+perPage));
    }

    const w = window.open('', '_blank');
    const css = `
      @page { size: auto; margin: 14mm }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#0b0b0b; }
      header{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
      header img{ width:60px; height:60px; object-fit:contain; }
      .t1{ font-size:18pt; font-weight:800; }
      .t2{ font-size:11pt; color:#333 }
      .page{ page-break-after: always; }
      .page:last-child{ page-break-after: auto; }
      .row{ border-bottom:1px solid #ddd; padding:6px 0; }
      .name{ font-weight:800; font-size:12.5pt; }
      .meta{ font-size:10.3pt; color:#333 }
      .idx{ color:#2563eb; font-weight:700; }
      .badge{ display:inline-block; font-size:9pt; padding:2px 8px; border:1px solid #777; border-radius:999px; margin-left:8px; }
    `;

    const makeRows = (arr) => arr.map(p => {
      const data = (p.data ? fmtITDate(String(p.data)) : '–');
      const badge = `<span class="badge">${(p.sesso||'M')==='F'?'F · Rosa':'M · Azzurro'}</span>`;
      const line1 = `<span class="name"><span class="idx">${String(p.index).padStart(3,'0')}</span> · ${(p.cognome||'').toUpperCase()} ${p.nome||''} ${badge}</span>`;
      const line2 = `<div class="meta">${p.luogo||'–'} (${p.proNasc||'–'}) · ${data} · Res: ${p.res||'–'} (${p.proRes||'–'}) · Tess: ${p.tess||'–'} · CF: ${p.cf||'–'}</div>`;
      return `<div class="row">${line1}${line2}</div>`;
    }).join('');

    const htmlDoc = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Esporta Soci</title><style>${css}</style></head><body>
      ${pages.map((page,pi)=>`
        <div class="page">
          <header>
            ${logo ? `<img src="${logo}" alt="Logo">` : ''}
            <div>
              <div class="t1">${title}</div>
              <div class="t2">${subtitle} – Elenco completo Soci · ${new Date().toLocaleDateString()}</div>
            </div>
          </header>
          ${makeRows(page)}
        </div>
      `).join('')}
    <!-- MOD: Shared Province datalist (PR) -->
<datalist id="provSigle">
  <option value="AG"></option>
  <option value="AL"></option>
  <option value="AN"></option>
  <option value="AO"></option>
  <option value="AQ"></option>
  <option value="AR"></option>
  <option value="AP"></option>
  <option value="AT"></option>
  <option value="AV"></option>
  <option value="BA"></option>
  <option value="BT"></option>
  <option value="BL"></option>
  <option value="BN"></option>
  <option value="BG"></option>
  <option value="BI"></option>
  <option value="BO"></option>
  <option value="BZ"></option>
  <option value="BS"></option>
  <option value="BR"></option>
  <option value="CA"></option>
  <option value="CL"></option>
  <option value="CB"></option>
  <option value="CE"></option>
  <option value="CT"></option>
  <option value="CZ"></option>
  <option value="CH"></option>
  <option value="CO"></option>
  <option value="CS"></option>
  <option value="CR"></option>
  <option value="KR"></option>
  <option value="CN"></option>
  <option value="EN"></option>
  <option value="FM"></option>
  <option value="FE"></option>
  <option value="FI"></option>
  <option value="FG"></option>
  <option value="FC"></option>
  <option value="FR"></option>
  <option value="GE"></option>
  <option value="GO"></option>
  <option value="GR"></option>
  <option value="IM"></option>
  <option value="IS"></option>
  <option value="SP"></option>
  <option value="LT"></option>
  <option value="LE"></option>
  <option value="LC"></option>
  <option value="LI"></option>
  <option value="LO"></option>
  <option value="LU"></option>
  <option value="MC"></option>
  <option value="MN"></option>
  <option value="MS"></option>
  <option value="MT"></option>
  <option value="ME"></option>
  <option value="MI"></option>
  <option value="MO"></option>
  <option value="MB"></option>
  <option value="NA"></option>
  <option value="NO"></option>
  <option value="NU"></option>
  <option value="OR"></option>
  <option value="PD"></option>
  <option value="PA"></option>
  <option value="PR"></option>
  <option value="PV"></option>
  <option value="PG"></option>
  <option value="PU"></option>
  <option value="PI"></option>
  <option value="PT"></option>
  <option value="PN"></option>
  <option value="PZ"></option>
  <option value="PO"></option>
  <option value="RG"></option>
  <option value="RA"></option>
  <option value="RC"></option>
  <option value="RE"></option>
  <option value="RI"></option>
  <option value="RN"></option>
  <option value="RM"></option>
  <option value="RO"></option>
  <option value="SA"></option>
  <option value="SS"></option>
  <option value="SV"></option>
  <option value="SI"></option>
  <option value="SR"></option>
  <option value="SO"></option>
  <option value="TA"></option>
  <option value="TE"></option>
  <option value="TR"></option>
  <option value="TO"></option>
  <option value="TP"></option>
  <option value="TN"></option>
  <option value="TV"></option>
  <option value="TS"></option>
  <option value="UD"></option>
  <option value="VA"></option>
  <option value="VE"></option>
  <option value="VB"></option>
  <option value="VC"></option>
  <option value="VR"></option>
  <option value="VV"></option>
  <option value="VI"></option>
  <option value="VT"></option>
  <option value="SU"></option>
</datalist>

<style id="cnp_appunti_2025-09-03">
  #cardTrasferte .name.note-active {
    color: #f59e0b !important;
    text-decoration: underline;
    text-decoration-thickness: 3px;
    text-underline-offset: 3px;
  }
  #cardTrasferte .name .appunto {
    margin-left: 8px;
    font-size: .95em;
    font-style: italic;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(245,158,11,.15);
    border: 1px solid rgba(245,158,11,.45);
    color: #ffedd5;
    white-space: pre-wrap;
  }
</style>


<style id="cnp_appunti_print_2025-09-03">
@media print {
  #cardTrasferte .name.note-active {
    color: #000 !important;
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }
  #cardTrasferte .name .appunto {
    background: none !important;
    border: none !important;
    color: #000 !important;
    padding: 0 !important;
    font-style: normal;
  }
  #cardTrasferte .name .appunto::before {
    content: " — Appunto: ";
    font-weight: 600;
  }
  #cardTrasferte * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
</style>


<style id="cnp_gender_override_trasferte_2025-09-03">
/* Disabilita la colorazione per genere SOLO nella lista Trasferte */
#cardTrasferte .female, 
#cardTrasferte .gender-female,
#cardTrasferte .gender-f,
#cardTrasferte .woman,
#cardTrasferte .donna {
  color: inherit !important;
  background: inherit !important;
  border-color: inherit !important;
  filter: none !important;
}
#cardTrasferte .name .tag.female,
#cardTrasferte .badge.female,
#cardTrasferte .pill.female,
#cardTrasferte .chip.female {
  background: var(--accent, #3b82f6) !important; /* usa colore standard */
  color: white !important;
  border-color: transparent !important;
}
/* Se il nome veniva colorato con :has(.female) o simili, neutralizza */
#cardTrasferte .name { color: inherit !important; }
</style>


<!-- Firebase + Cloud Sync with Config Helper -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
(function(){
  // 1) CONFIG HELPER ---------------------------------------------------------
  // Default config (può essere sbagliata; se non funziona, chiediamo di incollarne una corretta)
  var DEFAULT_CONFIG = {
    apiKey: "AIzaSyBfBR_YNt-kTFoa-SAFbWk15UoS1a1X03k",
    authDomain: "club-napoli-modena.firebaseapp.com",
    projectId: "club-napoli-modena",
    storageBucket: "club-napoli-modena.firebasestorage.app",
    messagingSenderId: "143536134939",
    appId: "1:143536134939:web:8a0086b0b05a6a916df51be"
  };

  function parseMaybeJSON(txt){
    try{ return JSON.parse(txt); }catch(_){ return null; }
  }

  // Leggi eventuale config salvata localmente
  var saved = localStorage.getItem('firebaseConfigJSON');
  var cfg = saved ? parseMaybeJSON(saved) : null;
  if(!cfg || !cfg.apiKey){
    cfg = DEFAULT_CONFIG;
  }
  window._firebaseConfig = cfg;

  // UI badge (usa i chip esistenti "Offline"/"Connesso" + ne aggiunge uno se manca)
  function paintAll(status){
    var chips = Array.from(document.querySelectorAll('.chip, span'));
    var touched = false;
    chips.forEach(function(el){
      var t = (el.textContent||'').trim().toLowerCase();
      if(t==='offline' || t==='connesso'){
        el.textContent = status ? 'Connesso' : 'Offline';
        el.style.background = status ? '#065f46' : '#334155';
        el.style.color = status ? '#d1fae5' : '#e5e7eb';
        el.style.borderColor = status ? '#10b981' : '#475569';
        touched = true;
      }
    });
    if(!touched){
      var b = document.createElement('span');
      b.textContent = status ? 'Connesso' : 'Offline';
      b.className = 'chip';
      b.style.marginLeft = '6px';
      b.style.background = status ? '#065f46' : '#334155';
      b.style.color = status ? '#d1fae5' : '#e5e7eb';
      b.style.border = '1px solid ' + (status ? '#10b981' : '#475569');
      (document.querySelector('.toolbar')||document.body).appendChild(b);
    }
  }

  function askForConfigAndReload(message){
    var txt = prompt((message||'') + '\n\nIncolla qui l’oggetto di configurazione Firebase (da { a }):');
    if(!txt){ return; }
    // Permette incollare direttamente l'oggetto senza JSON.stringify
    // Proviamo a trasformarlo in JSON valido
    try{
      // Sostituisci chiavi non tra virgolette con virgolette (grezzo ma utile)
      var fixed = txt.trim();
      // se inizia con 'const firebaseConfig = {', estrai solo { ... }
      var m = fixed.match(/\{[\s\S]*\}$/);
      if(m) fixed = m[0];
      // Converte in JSON grezzo: metti doppi apici sulle chiavi se mancanti
      fixed = fixed.replace(/(\w+)\s*:/g, '"$1":');
      var obj = JSON.parse(fixed);
      if(!obj.apiKey){ alert('Config non valida: manca apiKey'); return; }
      localStorage.setItem('firebaseConfigJSON', JSON.stringify(obj));
      alert('Config salvata. La pagina verrà ricaricata.');
      location.reload();
    }catch(e){
      console.error(e);
      alert('Config non valida. Assicurati di incollare l’oggetto completo { apiKey: "...", ... }');
    }
  }

  // 2) INIT + SYNC -----------------------------------------------------------
  const FIRE_COLLECTION = 'clubs';
  const FIRE_DOC_ID = 'club-napoli-modena';
  paintAll(false);

  function start(){
    const db = firebase.firestore();
    // signin anonimo
    firebase.auth().signInAnonymously().then(function(){
      paintAll(true);
      runSync(db);
    }).catch(function(err){
      console.warn('Auth anonima errore:', err);
      paintAll(false);
      if(String(err && err.code).includes('api-key')){
        askForConfigAndReload('La apiKey non è valida.');
      }
      // altri errori verranno solo mostrati sulla console
    });
  }

  function runSync(db){
    let lastLocalWriteTs = 0, applyingRemote = false;
    function now(){ return Date.now(); }
    function getPayload(){
      try{
        const state = JSON.parse(localStorage.getItem('club-napoli-db-v1')||'{}');
        const titles = JSON.parse(localStorage.getItem('club-napoli-titles')||'{}');
        const logo = localStorage.getItem('club-napoli-logo')||null;
        const trasfTitle = localStorage.getItem('trasferte-title')||'';
        return { state, titles, logo, trasferta_title: trasfTitle };
      }catch(_){ return {}; }
    }
    function apply(pl){
      try{
        if(!pl) return;
        applyingRemote = true;
        if(pl.state) localStorage.setItem('club-napoli-db-v1', JSON.stringify(pl.state));
        if(pl.titles) localStorage.setItem('club-napoli-titles', JSON.stringify(pl.titles));
        if(pl.logo!=null) localStorage.setItem('club-napoli-logo', pl.logo);
        if(pl.trasferta_title!=null) localStorage.setItem('trasferte-title', pl.trasferta_title);
        if(typeof renderAll === 'function'){ renderAll(); } else { location.reload(); }
      } finally { applyingRemote = false; }
    }

    const ref = db.collection(FIRE_COLLECTION).doc(FIRE_DOC_ID);

    ref.onSnapshot(function(snap){
      if(!snap.exists) return;
      const data = snap.data();
      if(data._lastWriteTs && data._lastWriteTs === lastLocalWriteTs){ return; }
      apply(data);
    });

    const oldSave = (typeof window.save === 'function') ? window.save : null;
    window.save = function(){
      if(oldSave) oldSave();
      if(applyingRemote) return;
      const payload = getPayload();
      lastLocalWriteTs = now();
      ref.set({ ...payload, _lastWriteTs: lastLocalWriteTs }, { merge: true })
         .catch(function(e){ console.error('Sync up error', e); });
    };

    ref.get().then(function(snap){
      if(!snap.exists){
        const payload = getPayload();
        lastLocalWriteTs = now();
        return ref.set({ ...payload, _lastWriteTs: lastLocalWriteTs });
      }
    });
  }

  try {
    firebase.initializeApp(window._firebaseConfig);
    start();
  } catch(e){
    console.warn('Init error:', e);
    if(String(e && e.message).toLowerCase().includes('api-key')){
      askForConfigAndReload('La apiKey non è valida.');
    }
  }
})();
</script>

</body></html>`;

    w.document.open(); w.document.write(htmlDoc); w.document.close();
    w.focus();
    w.onload = () => { w.print(); };
  }

  // Stampa Trasferte con scelta voci per pagina
  function printTrasferte(){
    if(!state.trasferte.length){ alert('La lista Trasferte è vuota.'); return; }
    let perPage = prompt('Quanti nominativi per pagina?', '20');
    if(perPage===null) return;
    perPage = parseInt(perPage, 10);
    if(isNaN(perPage) || perPage<=0){ alert('Valore non valido'); return; }
    const entries = state.trasferte.map((t,i)=>{
      const src=t.from==='soci'? state.soci : state.accomp;
      const p=src.find(x=>x.id===t.idRef);
      return p ? { index:i+1, hl: !!t.hl, ...p } : null;
    }).filter(Boolean);

    const title = document.getElementById('clubTitle').textContent.trim() || 'CLUB NAPOLI PARTENPEI';
    const subtitle = document.getElementById('clubSubtitle').textContent.trim() || 'Trasferte';
    const listTitle = (document.getElementById('trasfertaNome')?.value || '').trim() || 'Trasferte';
    const logo = localStorage.getItem('club-napoli-logo');

    const pages = [];
    for(let i=0;i<entries.length;i+=perPage){
      pages.push(entries.slice(i, i+perPage));
    }

    const w = window.open('', '_blank');
    const css = `
      @page { size: auto; margin: 14mm }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#0b0b0b; }
      header{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
      header img{ width:60px; height:60px; object-fit:contain; }
      .t1{ font-size:18pt; font-weight:800; }
      .t2{ font-size:11pt; color:#333 }
      .page{ page-break-after: always; }
      .page:last-child{ page-break-after: auto; }
      .row{ border-bottom:1px solid #ddd; padding:6px 0; }
      .row.hl{ background:#d1fae5; }
      .row.hl .name{ text-decoration: underline; text-decoration-thickness:2px; text-underline-offset:2px; }
      .name{ font-weight:800; font-size:12.5pt; }
      .meta{ font-size:10.3pt; color:#333 }
      .idx{ color:#2563eb; font-weight:700; }
    `;

    const makeRows = (arr) => arr.map(p => {
      const data = (p.data ? fmtITDate(String(p.data)) : '–');
      const line1 = `<span class="name"><span class="idx">${String(p.index).padStart(3,'0')}</span> · ${ (p.cognome||'').toUpperCase() } ${p.nome||''}</span>`;
      const line2 = `<div class="meta">${p.luogo||'–'} (${p.proNasc||'–'}) · ${data} · Res: ${p.res||'–'} (${p.proRes||'–'}) · Tess: ${p.tess||'–'} · CF: ${p.cf||'–'}</div>`;
      return `<div class="row ${p.hl?'hl':''}">${line1}${line2}</div>`;
    }).join('');

    const htmlDoc = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Stampa Trasferte</title><style>${css}</style></head><body>
      ${pages.map((page,pi)=>`
        <div class="page">
          <header>
            ${logo ? `<img src="${logo}" alt="Logo">` : ''}
            <div>
              <div class="t1">${title}</div>
              <div class="t2">${subtitle} – Lista Trasferte: ${listTitle} · ${new Date().toLocaleDateString()}</div>
            </div>
          </header>
          ${makeRows(page)}
        </div>
      `).join('')}
    <!-- MOD: Shared Province datalist (PR) -->
<datalist id="provSigle">
  <option value="AG"></option>
  <option value="AL"></option>
  <option value="AN"></option>
  <option value="AO"></option>
  <option value="AQ"></option>
  <option value="AR"></option>
  <option value="AP"></option>
  <option value="AT"></option>
  <option value="AV"></option>
  <option value="BA"></option>
  <option value="BT"></option>
  <option value="BL"></option>
  <option value="BN"></option>
  <option value="BG"></option>
  <option value="BI"></option>
  <option value="BO"></option>
  <option value="BZ"></option>
  <option value="BS"></option>
  <option value="BR"></option>
  <option value="CA"></option>
  <option value="CL"></option>
  <option value="CB"></option>
  <option value="CE"></option>
  <option value="CT"></option>
  <option value="CZ"></option>
  <option value="CH"></option>
  <option value="CO"></option>
  <option value="CS"></option>
  <option value="CR"></option>
  <option value="KR"></option>
  <option value="CN"></option>
  <option value="EN"></option>
  <option value="FM"></option>
  <option value="FE"></option>
  <option value="FI"></option>
  <option value="FG"></option>
  <option value="FC"></option>
  <option value="FR"></option>
  <option value="GE"></option>
  <option value="GO"></option>
  <option value="GR"></option>
  <option value="IM"></option>
  <option value="IS"></option>
  <option value="SP"></option>
  <option value="LT"></option>
  <option value="LE"></option>
  <option value="LC"></option>
  <option value="LI"></option>
  <option value="LO"></option>
  <option value="LU"></option>
  <option value="MC"></option>
  <option value="MN"></option>
  <option value="MS"></option>
  <option value="MT"></option>
  <option value="ME"></option>
  <option value="MI"></option>
  <option value="MO"></option>
  <option value="MB"></option>
  <option value="NA"></option>
  <option value="NO"></option>
  <option value="NU"></option>
  <option value="OR"></option>
  <option value="PD"></option>
  <option value="PA"></option>
  <option value="PR"></option>
  <option value="PV"></option>
  <option value="PG"></option>
  <option value="PU"></option>
  <option value="PI"></option>
  <option value="PT"></option>
  <option value="PN"></option>
  <option value="PZ"></option>
  <option value="PO"></option>
  <option value="RG"></option>
  <option value="RA"></option>
  <option value="RC"></option>
  <option value="RE"></option>
  <option value="RI"></option>
  <option value="RN"></option>
  <option value="RM"></option>
  <option value="RO"></option>
  <option value="SA"></option>
  <option value="SS"></option>
  <option value="SV"></option>
  <option value="SI"></option>
  <option value="SR"></option>
  <option value="SO"></option>
  <option value="TA"></option>
  <option value="TE"></option>
  <option value="TR"></option>
  <option value="TO"></option>
  <option value="TP"></option>
  <option value="TN"></option>
  <option value="TV"></option>
  <option value="TS"></option>
  <option value="UD"></option>
  <option value="VA"></option>
  <option value="VE"></option>
  <option value="VB"></option>
  <option value="VC"></option>
  <option value="VR"></option>
  <option value="VV"></option>
  <option value="VI"></option>
  <option value="VT"></option>
  <option value="SU"></option>
</datalist>

<style id="cnp_appunti_2025-09-03">
  #cardTrasferte .name.note-active {
    color: #f59e0b !important;
    text-decoration: underline;
    text-decoration-thickness: 3px;
    text-underline-offset: 3px;
  }
  #cardTrasferte .name .appunto {
    margin-left: 8px;
    font-size: .95em;
    font-style: italic;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(245,158,11,.15);
    border: 1px solid rgba(245,158,11,.45);
    color: #ffedd5;
    white-space: pre-wrap;
  }
</style>


<style id="cnp_appunti_print_2025-09-03">
@media print {
  #cardTrasferte .name.note-active {
    color: #000 !important;
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }
  #cardTrasferte .name .appunto {
    background: none !important;
    border: none !important;
    color: #000 !important;
    padding: 0 !important;
    font-style: normal;
  }
  #cardTrasferte .name .appunto::before {
    content: " — Appunto: ";
    font-weight: 600;
  }
  #cardTrasferte * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
</style>


<style id="cnp_gender_override_trasferte_2025-09-03">
/* Disabilita la colorazione per genere SOLO nella lista Trasferte */
#cardTrasferte .female, 
#cardTrasferte .gender-female,
#cardTrasferte .gender-f,
#cardTrasferte .woman,
#cardTrasferte .donna {
  color: inherit !important;
  background: inherit !important;
  border-color: inherit !important;
  filter: none !important;
}
#cardTrasferte .name .tag.female,
#cardTrasferte .badge.female,
#cardTrasferte .pill.female,
#cardTrasferte .chip.female {
  background: var(--accent, #3b82f6) !important; /* usa colore standard */
  color: white !important;
  border-color: transparent !important;
}
/* Se il nome veniva colorato con :has(.female) o simili, neutralizza */
#cardTrasferte .name { color: inherit !important; }
</style>


<!-- Firebase + Cloud Sync with Config Helper -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
(function(){
  // 1) CONFIG HELPER ---------------------------------------------------------
  // Default config (può essere sbagliata; se non funziona, chiediamo di incollarne una corretta)
  var DEFAULT_CONFIG = {
    apiKey: "AIzaSyBfBR_YNt-kTFoa-SAFbWk15UoS1a1X03k",
    authDomain: "club-napoli-modena.firebaseapp.com",
    projectId: "club-napoli-modena",
    storageBucket: "club-napoli-modena.firebasestorage.app",
    messagingSenderId: "143536134939",
    appId: "1:143536134939:web:8a0086b0b05a6a916df51be"
  };

  function parseMaybeJSON(txt){
    try{ return JSON.parse(txt); }catch(_){ return null; }
  }

  // Leggi eventuale config salvata localmente
  var saved = localStorage.getItem('firebaseConfigJSON');
  var cfg = saved ? parseMaybeJSON(saved) : null;
  if(!cfg || !cfg.apiKey){
    cfg = DEFAULT_CONFIG;
  }
  window._firebaseConfig = cfg;

  // UI badge (usa i chip esistenti "Offline"/"Connesso" + ne aggiunge uno se manca)
  function paintAll(status){
    var chips = Array.from(document.querySelectorAll('.chip, span'));
    var touched = false;
    chips.forEach(function(el){
      var t = (el.textContent||'').trim().toLowerCase();
      if(t==='offline' || t==='connesso'){
        el.textContent = status ? 'Connesso' : 'Offline';
        el.style.background = status ? '#065f46' : '#334155';
        el.style.color = status ? '#d1fae5' : '#e5e7eb';
        el.style.borderColor = status ? '#10b981' : '#475569';
        touched = true;
      }
    });
    if(!touched){
      var b = document.createElement('span');
      b.textContent = status ? 'Connesso' : 'Offline';
      b.className = 'chip';
      b.style.marginLeft = '6px';
      b.style.background = status ? '#065f46' : '#334155';
      b.style.color = status ? '#d1fae5' : '#e5e7eb';
      b.style.border = '1px solid ' + (status ? '#10b981' : '#475569');
      (document.querySelector('.toolbar')||document.body).appendChild(b);
    }
  }

  function askForConfigAndReload(message){
    var txt = prompt((message||'') + '\n\nIncolla qui l’oggetto di configurazione Firebase (da { a }):');
    if(!txt){ return; }
    // Permette incollare direttamente l'oggetto senza JSON.stringify
    // Proviamo a trasformarlo in JSON valido
    try{
      // Sostituisci chiavi non tra virgolette con virgolette (grezzo ma utile)
      var fixed = txt.trim();
      // se inizia con 'const firebaseConfig = {', estrai solo { ... }
      var m = fixed.match(/\{[\s\S]*\}$/);
      if(m) fixed = m[0];
      // Converte in JSON grezzo: metti doppi apici sulle chiavi se mancanti
      fixed = fixed.replace(/(\w+)\s*:/g, '"$1":');
      var obj = JSON.parse(fixed);
      if(!obj.apiKey){ alert('Config non valida: manca apiKey'); return; }
      localStorage.setItem('firebaseConfigJSON', JSON.stringify(obj));
      alert('Config salvata. La pagina verrà ricaricata.');
      location.reload();
    }catch(e){
      console.error(e);
      alert('Config non valida. Assicurati di incollare l’oggetto completo { apiKey: "...", ... }');
    }
  }

  // 2) INIT + SYNC -----------------------------------------------------------
  const FIRE_COLLECTION = 'clubs';
  const FIRE_DOC_ID = 'club-napoli-modena';
  paintAll(false);

  function start(){
    const db = firebase.firestore();
    // signin anonimo
    firebase.auth().signInAnonymously().then(function(){
      paintAll(true);
      runSync(db);
    }).catch(function(err){
      console.warn('Auth anonima errore:', err);
      paintAll(false);
      if(String(err && err.code).includes('api-key')){
        askForConfigAndReload('La apiKey non è valida.');
      }
      // altri errori verranno solo mostrati sulla console
    });
  }

  function runSync(db){
    let lastLocalWriteTs = 0, applyingRemote = false;
    function now(){ return Date.now(); }
    function getPayload(){
      try{
        const state = JSON.parse(localStorage.getItem('club-napoli-db-v1')||'{}');
        const titles = JSON.parse(localStorage.getItem('club-napoli-titles')||'{}');
        const logo = localStorage.getItem('club-napoli-logo')||null;
        const trasfTitle = localStorage.getItem('trasferte-title')||'';
        return { state, titles, logo, trasferta_title: trasfTitle };
      }catch(_){ return {}; }
    }
    function apply(pl){
      try{
        if(!pl) return;
        applyingRemote = true;
        if(pl.state) localStorage.setItem('club-napoli-db-v1', JSON.stringify(pl.state));
        if(pl.titles) localStorage.setItem('club-napoli-titles', JSON.stringify(pl.titles));
        if(pl.logo!=null) localStorage.setItem('club-napoli-logo', pl.logo);
        if(pl.trasferta_title!=null) localStorage.setItem('trasferte-title', pl.trasferta_title);
        if(typeof renderAll === 'function'){ renderAll(); } else { location.reload(); }
      } finally { applyingRemote = false; }
    }

    const ref = db.collection(FIRE_COLLECTION).doc(FIRE_DOC_ID);

    ref.onSnapshot(function(snap){
      if(!snap.exists) return;
      const data = snap.data();
      if(data._lastWriteTs && data._lastWriteTs === lastLocalWriteTs){ return; }
      apply(data);
    });

    const oldSave = (typeof window.save === 'function') ? window.save : null;
    window.save = function(){
      if(oldSave) oldSave();
      if(applyingRemote) return;
      const payload = getPayload();
      lastLocalWriteTs = now();
      ref.set({ ...payload, _lastWriteTs: lastLocalWriteTs }, { merge: true })
         .catch(function(e){ console.error('Sync up error', e); });
    };

    ref.get().then(function(snap){
      if(!snap.exists){
        const payload = getPayload();
        lastLocalWriteTs = now();
        return ref.set({ ...payload, _lastWriteTs: lastLocalWriteTs });
      }
    });
  }

  try {
    firebase.initializeApp(window._firebaseConfig);
    start();
  } catch(e){
    console.warn('Init error:', e);
    if(String(e && e.message).toLowerCase().includes('api-key')){
      askForConfigAndReload('La apiKey non è valida.');
    }
  }
})();
</script>

</body></html>`;

    w.document.open(); w.document.write(htmlDoc); w.document.close();
    w.focus();
    w.onload = () => { w.print(); };
  }

  document.getElementById('btnPrintTrasferte').addEventListener('click', printTrasferte);
  document.getElementById('btnExportSociPdf').addEventListener('click', exportSociPdf);
  document.getElementById('btnArchiveTrasferta').addEventListener('click', ()=>{
    if(!state.trasferte.length){ alert('La lista Trasferte è vuota.'); return; }
    const listTitle = (document.getElementById('trasfertaNome')?.value || '').trim() || 'Trasferte';
    const titolo=prompt('Titolo della Trasferta conclusa', listTitle);
    const snapshot=state.trasferte.map(t=>{ const src=t.from==='soci'? state.soci : state.accomp; const p=src.find(x=>x.id===t.idRef); return {...t, snapshot: p?{...p}:null}; });
    state.archivio.unshift({id:Date.now(),titolo:titolo||('Trasferta '+new Date().toLocaleString()),elenco:snapshot});
    state.trasferte=[]; save(); renderTrasferte(); renderArchivio();
  });

  document.getElementById('toggleArchivio').addEventListener('click', ()=>{
    document.getElementById('archivioContainer').classList.toggle('hide');
  });

  function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms); } }

  // === Bus from form (Soci) — INSIDE IIFE ===
  // Salva/aggiorna il socio corrente e lo aggiunge a Trasferte
  (function(){
    const btn = byId('btnBusSocio');
    if(!btn) return;
    btn.addEventListener('click', ()=>{
      const o={
        nome:(S.nome?.value||'').trim(),
        cognome:(S.cognome?.value||'').trim(),
        luogo:(S.luogo?.value||'').trim(),
        proNasc:(S.proNasc?.value||'').trim().toUpperCase(),
        data:(S.data?.value||'').trim(),
        res:(S.res?.value||'').trim(),
        proRes:(S.proRes?.value||'').trim().toUpperCase(),
        tess:(S.tess?.value||'').trim(),
        cf:(S.cf?.value||'').trim().toUpperCase(),
        sesso:(S.sesso?.value)||'M',
        colore: sexColor((S.sesso?.value)||'M').txt
      };
      if(!o.nome || !o.cognome){ alert('Nome e Cognome sono obbligatori'); return; }

      let id = null;
      // 1) Se stai modificando un socio esistente
      if (editingSocioId){
        const i = state.soci.findIndex(x=>x.id===editingSocioId);
        if(i !== -1){ state.soci[i] = {...state.soci[i], ...o}; id = state.soci[i].id; }
        editingSocioId = null;
        if (S.editFlag) S.editFlag.style.display='none';
      }
      // 2) Se non stai modificando: prova corrispondenza CF
      if(!id && o.cf){
        const i = state.soci.findIndex(x=> (x.cf||'').toUpperCase()===o.cf);
        if(i !== -1){ state.soci[i] = {...state.soci[i], ...o}; id = state.soci[i].id; }
      }
      // 3) Prova Nome+Cognome+Data
      if(!id){
        const i = state.soci.findIndex(x=> (x.cognome||'').toLowerCase()===o.cognome.toLowerCase()
                                        && (x.nome||'').toLowerCase()===o.nome.toLowerCase()
                                        && (x.data||'')===(o.data||''));
        if(i !== -1){ state.soci[i] = {...state.soci[i], ...o}; id = state.soci[i].id; }
      }
      // 4) Altrimenti crea nuovo
      if(!id){
        id = uid();
        state.soci.push({id, ...o});
      }

      // Ordina e salva
      state.soci.sort((a,b)=> (a.cognome||'').localeCompare(b.cognome||'') || (a.nome||'').localeCompare(b.nome||''));
      save();
      renderAll();

      // Aggiungi a Trasferte
      if(!state.trasferte.some(t=>t.idRef===id && t.from==='soci')){
        state.trasferte.push({idRef:id, from:'soci'});
        save(); renderTrasferte();
      }

      clearSocio();
    });
  })();
})();


</script>
<style id="cnp_bundle_2025-08-24_vFinal2">
  /* ===== FONT PIÙ CHIARO (non tocca i NOMINATIVI .name) ===== */
  body :not(.name):not(.name *):not(svg):not(img) { color: #ffffff !important; }
  h1, h2, h3, h4, h5, h6 { color: #ffffff !important; }

  /* ===== UI più chiara ===== */
  body { background: linear-gradient(180deg, #7da2e6, #5c7fc7 60%) !important; }
  .section, .card { background: rgba(255,255,255,0.20) !important; }
  table, .table { background: rgba(255,255,255,0.10) !important; }
  input, select, textarea { background-color: rgba(255,255,255,0.08) !important; }
  /* Placeholders chiari */
  ::-webkit-input-placeholder { color: #ffffff !important; opacity: 1 !important; }
  ::-moz-placeholder { color: #ffffff !important; opacity: 1 !important; }
  :-ms-input-placeholder { color: #ffffff !important; opacity: 1 !important; }
  ::-ms-input-placeholder { color: #ffffff !important; opacity: 1 !important; }
  ::placeholder { color: #ffffff !important; opacity: 1 !important; }

  /* ===== SOLO NOMI COLORATI PER GENERE (se NON da rinnovare) ===== */
  #listSoci .item.sex-m .name:not(.stato-da-rinnovare),
  #listAccomp .item.sex-m .name:not(.stato-da-rinnovare) { color: #4da6ff !important; font-weight: 600; }
  #listSoci .item.sex-f .name:not(.stato-da-rinnovare),
  #listAccomp .item.sex-f .name:not(.stato-da-rinnovare) { color: #ff66b2 !important; font-weight: 600; }

  /* ===== RIMUOVI BANDE / FASCE COLORATE UOMO/DONNA ===== */
  #listSoci .item.sex-m, #listSoci .item.sex-f,
  #listAccomp .item.sex-m, #listAccomp .item.sex-f {
    background: transparent !important;
    box-shadow: none !important;
  }
  #listSoci .item.sex-m::before, #listSoci .item.sex-m::after,
  #listSoci .item.sex-f::before, #listSoci .item.sex-f::after,
  #listAccomp .item.sex-m::before, #listAccomp .item.sex-m::after,
  #listAccomp .item.sex-f::before, #listAccomp .item.sex-f::after {
    background: transparent !important;
    box-shadow: none !important;
    border-color: transparent !important;
  }

  /* ===== STATO DA RINNOVARE (ha priorità) ===== */
  .name.stato-da-rinnovare { color: red !important; font-weight: 700; }
  .stato-label { margin-left: 6px; font-size: 0.9em; font-style: italic; }

  /* ===== Colonna actions ancoraggio pulsante ===== */
  #listSoci .item .actions, #listAccomp .item .actions { position: relative; }
  .iconbtn.euro { font-weight: 700; }
</style>
<script id="cnp_toggle_persist_2025-08-24_vFinal2">
(function(){
  const STORAGE_KEY = 'clubNapoli_rinnovi_v1';

  function loadState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function saveState(obj){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    catch(e){}
  }
  function keyFor(item){
    const id = item.getAttribute('data-id') || '';
    const frm = item.getAttribute('data-from') || (item.closest('#listAccomp') ? 'accomp' : 'soci');
    if(id) return id + '|' + frm;
    const nameEl = item.querySelector('.name');
    const nameTxt = (nameEl && nameEl.textContent || '').trim();
    const index = Array.from(item.parentElement ? item.parentElement.children : []).indexOf(item);
    return nameTxt + '|' + frm + '|' + index;
  }

  function ensureEuroButton(item){
    const actions = item.querySelector('.actions');
    if(!actions) return;
    let euro = actions.querySelector('[data-act="euro"]');
    if(!euro){
      euro = document.createElement('button');
      euro.className = 'iconbtn euro';
      euro.setAttribute('data-act','euro');
      euro.title = 'Da Rinnovare (toggle)';
      euro.textContent = '€';
      actions.appendChild(euro);
    }
  }

  function restoreItem(item, state){
    const nameEl = item.querySelector('.name');
    if(!nameEl) return;
    // pulizia
    nameEl.classList.remove('stato-da-rinnovare','nome-maschio','nome-femmina');
    const old = nameEl.querySelector('.stato-label');
    if(old) old.remove();

    const k = keyFor(item);
    if(state[k]){
      nameEl.classList.add('stato-da-rinnovare');
      const tag = document.createElement('span');
      tag.className = 'stato-label';
      tag.textContent = '(DA RINNOVARE)';
      nameEl.appendChild(tag);
    } else {
      if(item.classList.contains('sex-m')) nameEl.classList.add('nome-maschio');
      else if(item.classList.contains('sex-f')) nameEl.classList.add('nome-femmina');
    }
  }

  function enhanceList(listId){
    const list = document.getElementById(listId);
    if(!list) return;
    const state = loadState();
    list.querySelectorAll('.item').forEach(item => {
      ensureEuroButton(item);
      restoreItem(item, state);
    });
  }

  function enhanceAll(){
    enhanceList('listSoci');
    enhanceList('listAccomp');
  }

  document.addEventListener('click', function(e){
    const euroBtn = e.target.closest('#listSoci .item .actions [data-act="euro"], #listAccomp .item .actions [data-act="euro"]');
    if(!euroBtn) return;
    const item = euroBtn.closest('.item');
    if(!item) return;
    const nameEl = item.querySelector('.name');
    if(!nameEl) return;

    const state = loadState();
    const k = keyFor(item);
    const already = nameEl.classList.contains('stato-da-rinnovare');

    nameEl.classList.remove('stato-da-rinnovare','nome-maschio','nome-femmina');
    const old = nameEl.querySelector('.stato-label');
    if(old) old.remove();

    if(already){
      state[k] = false;
      if(item.classList.contains('sex-m')) nameEl.classList.add('nome-maschio');
      else if(item.classList.contains('sex-f')) nameEl.classList.add('nome-femmina');
    }else{
      state[k] = true;
      nameEl.classList.add('stato-da-rinnovare');
      const tag = document.createElement('span');
      tag.className = 'stato-label';
      tag.textContent = '(DA RINNOVARE)';
      nameEl.appendChild(tag);
    }
    saveState(state);
  });

  document.addEventListener('DOMContentLoaded', function(){
    enhanceAll();
    ['listSoci','listAccomp'].forEach(id => {
      const el = document.getElementById(id);
      if(el && 'MutationObserver' in window){
        const obs = new MutationObserver(() => enhanceAll());
        obs.observe(el, { childList: true });
      }
    });
    setTimeout(enhanceAll, 300);
    setTimeout(enhanceAll, 800);
    setTimeout(enhanceAll, 1500);
  });
})();
</script>
<style id="font-slightly-darker-2025-08-24">
  body :not(.name):not(.name *):not(svg):not(img) {
    color: #f2f2f2 !important; /* un filo più scuro del bianco puro */
  }
  h1, h2, h3, h4, h5, h6 {
    color: #f5f5f5 !important; /* titoli appena meno "sparati" */
  }
</style>
<style id="font-slightly-darker-2025-08-24-v2">
  body :not(.name):not(.name *):not(svg):not(img) {
    color: #ededed !important; /* un filo più scuro di #f2f2f2 */
  }
  h1, h2, h3, h4, h5, h6 {
    color: #f2f2f2 !important; /* titoli ancora chiari ma meno sparati */
  }
</style>
<style id="font-slightly-darker-2025-08-24-v3">
  body :not(.name):not(.name *):not(svg):not(img) {
    color: #e9e9e9 !important; /* un altro mezzo step più scuro */
  }
  h1, h2, h3, h4, h5, h6 {
    color: #ededed !important; /* titoli coerenti ma ancora chiari */
  }
</style>
<style id="font-slightly-darker-2025-08-24-v4">
  body :not(.name):not(.name *):not(svg):not(img) {
    color: #e6e6e6 !important; /* mezzo step più scuro */
  }
  h1, h2, h3, h4, h5, h6 {
    color: #e9e9e9 !important; /* titoli coerenti ma chiari */
  }
</style>
<style id="ui-darken-2025-08-24">
  /* Sfondo leggermente più scuro */
  body {
    background: linear-gradient(180deg, #5d78bd, #3f5aa3 60%) !important;
  }
  /* Pannelli/sezioni un filo più scuri per aumentare il contrasto */
  .section, .card {
    background: rgba(0,0,0,0.18) !important;
  }
  /* Tabelle e contenitori un po' più scuri */
  table, .table {
    background: rgba(0,0,0,0.10) !important;
  }
  /* Campi input leggermente più scuri */
  input, select, textarea {
    background-color: rgba(0,0,0,0.18) !important;
  }
  /* Divider/linee coerenti */
  hr, .line, .divider {
    border-color: rgba(255,255,255,0.15) !important;
  }
</style>
<style id="uniform-bg-6179b8">
  /* Sfondo uniforme come da colore evidenziato (#6179B8) */
  body {
    background: #6179b8 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-576DA6">
  /* Sfondo uniforme leggermente più scuro (#576DA6) */
  body {
    background: #576DA6 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-4F66A4">
  /* Sfondo uniforme un po' più scuro (#4F66A4) */
  body {
    background: #4F66A4 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-475C93">
  /* Sfondo uniforme un po' più scuro (#475C93) */
  body {
    background: #475C93 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-405489">
  /* Sfondo uniforme ancora un po' più scuro (#405489) */
  body {
    background: #405489 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-3A4C80">
  /* Sfondo uniforme più scuro (#3A4C80) */
  body {
    background: #3A4C80 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-334373">
  /* Sfondo uniforme più scuro (#334373) */
  body {
    background: #334373 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-2D3C69">
  /* Sfondo uniforme più scuro (#2D3C69) */
  body {
    background: #2D3C69 !important;
    background-image: none !important;
  }
</style>
<style id="uniform-bg-27355F">
  /* Sfondo uniforme più scuro (#27355F) */
  body {
    background: #27355F !important;
    background-image: none !important;
  }
</style>
<style id="female-name-soft-pink-override-2025-08-24">
  /* Nominativi femminili in rosa più soft (no fucsia) */
  #listSoci .item.sex-f .name:not(.stato-da-rinnovare),
  #listAccomp .item.sex-f .name:not(.stato-da-rinnovare) {
    color: #FFC0CB !important; /* Pink pastello */
    font-weight: 600;
  }
</style>
<style id="darinnovare-align-to-name-v3">
  /* Etichetta allineata al NOMINATIVO: inline, sulla stessa baseline del nome */
  #listSoci .item .stato-label, #listAccomp .item .stato-label {
    position: static !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
    display: inline-block !important;
    margin-left: 8px !important;
    white-space: nowrap !important;
    vertical-align: baseline !important;
    pointer-events: none !important;
    color: red !important;
    font-weight: 700 !important;
  }
</style>
<script id="darinnovare-align-to-name-v3-js">
(function(){
  function inlineAlign(item){
    if(!item) return;
    var nameEl = item.querySelector('.name');
    var label  = item.querySelector('.stato-label');
    if(!nameEl || !label) return;
    if(label.parentElement !== nameEl){
      try { item.removeChild(label); } catch(e){}
      nameEl.appendChild(label);
    }
    // reset style inline to be sure
    var s = label.style;
    s.position = 'static';
    s.left = 'auto';
    s.top = 'auto';
    s.transform = 'none';
    s.marginLeft = '8px';
    s.whiteSpace = 'nowrap';
    s.verticalAlign = 'baseline';
    s.pointerEvents = 'none';
    s.fontWeight = '700';
    s.color = 'red';
  }

  function fixAll(){
    document.querySelectorAll('#listSoci .item, #listAccomp .item').forEach(inlineAlign);
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Rimuovi eventuali vecchi script di centraggio che spostavano la label
    ['darinnovare-align-fix-2025-08-24','darinnovare-align-fix-v2'].forEach(function(id){
      var el = document.getElementById(id);
      if(el) try { el.remove(); } catch(e){}
    });
    ['darinnovare-align-fix-v2-js','darinnovare-align-fix-js-2025-08-24'].forEach(function(id){
      var el = document.getElementById(id);
      if(el) try { el.remove(); } catch(e){}
    });

    // Prime correzioni
    setTimeout(fixAll, 0);
    setTimeout(fixAll, 100);
    setTimeout(fixAll, 300);
    setTimeout(fixAll, 800);

    // Click su €: dopo il toggle, riallinea accanto al nome
    document.addEventListener('click', function(e){
      var euro = e.target.closest('#listSoci .item .actions [data-act="euro"], #listAccomp .item .actions [data-act="euro"]');
      if(euro){
        var item = euro.closest('.item');
        setTimeout(function(){ inlineAlign(item); }, 0);
        setTimeout(function(){ inlineAlign(item); }, 120);
      }
    });

    // Osserva cambi strutturali e riafferma la posizione inline
    ['listSoci','listAccomp'].forEach(function(id){
      var el = document.getElementById(id);
      if(el && 'MutationObserver' in window){
        var obs = new MutationObserver(function(){ setTimeout(fixAll, 0); });
        obs.observe(el, { childList: true, subtree: true });
      }
    });

    // Su resize/scroll non dovrebbe servire, ma manteniamo un richiamo soft
    window.addEventListener('resize', function(){ setTimeout(fixAll, 0); });
  });
})();
</script>
<style id="stato-label-inline-final">
  /* Stato label INLINE accanto al nome */
  #listSoci .item .stato-label, #listAccomp .item .stato-label {
    position: static !important;
    display: inline-block !important;
    margin-left: 8px !important;
    white-space: nowrap !important;
    vertical-align: baseline !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
    pointer-events: none !important;
    color: red !important;
    font-weight: 700 !important;
  }
</style>
<script id="stato-label-inline-final-js">
(function(){
  function ensureInline(item){
    if(!item) return;
    var nameEl = item.querySelector('.name');
    var label  = item.querySelector('.stato-label');
    if(!nameEl || !label) return;
    // Sposta la label dentro il nome
    if(label.parentElement !== nameEl){
      try { label.parentElement.removeChild(label); } catch(e){}
      nameEl.appendChild(label);
    }
    // Reset esplicito di eventuali stili inline preesistenti
    ['position','left','top','transform','marginLeft','whiteSpace','verticalAlign'].forEach(function(prop){
      label.style[prop] = '';
    });
    // Reimposta i valori desiderati
    label.style.position = 'static';
    label.style.display = 'inline-block';
    label.style.marginLeft = '8px';
    label.style.whiteSpace = 'nowrap';
    label.style.verticalAlign = 'baseline';
    label.style.pointerEvents = 'none';
    label.style.fontWeight = '700';
    label.style.color = 'red';
  }

  function fixAll(){
    document.querySelectorAll('#listSoci .item, #listAccomp .item').forEach(ensureInline);
  }

  document.addEventListener('DOMContentLoaded', function(){
    fixAll();
    setTimeout(fixAll, 100);
    setTimeout(fixAll, 400);
    // Riallinea dopo toggle €
    document.addEventListener('click', function(e){
      var euro = e.target.closest('#listSoci .item .actions [data-act="euro"], #listAccomp .item .actions [data-act="euro"]');
      if(euro){
        var item = euro.closest('.item');
        setTimeout(function(){ ensureInline(item); }, 0);
        setTimeout(function(){ ensureInline(item); }, 120);
      }
    });
    // Osserva cambi
    ['listSoci','listAccomp'].forEach(function(id){
      var el = document.getElementById(id);
      if(el && 'MutationObserver' in window){
        var obs = new MutationObserver(function(){ setTimeout(fixAll, 0); });
        obs.observe(el, { childList: true, subtree: true });
      }
    });
  });
})();
</script>
<style id="darinnovare-align-to-name-tweak-2025-08-24">
  /* Sposta la label leggermente più su e a destra accanto al nominativo */
  #listSoci .item .name .stato-label,
  #listAccomp .item .name .stato-label {
    position: relative !important;
    top: -2px !important;          /* un filo più su */
    margin-left: 10px !important;  /* un po' più a destra */
  }
</style>
<style id="darinnovare-align-to-name-tweak-2025-08-24-v2">
  /* Micro-regolazione: appena più giù (da -2px a -1px) */
  #listSoci .item .name .stato-label,
  #listAccomp .item .name .stato-label {
    position: relative !important;
    top: -1px !important;         /* pochissimo più giù */
    margin-left: 10px !important; /* invariato */
  }
</style>
<!-- MOD: Shared Province datalist (PR) -->
<datalist id="provSigle">
<option value="AG"></option>
<option value="AL"></option>
<option value="AN"></option>
<option value="AO"></option>
<option value="AQ"></option>
<option value="AR"></option>
<option value="AP"></option>
<option value="AT"></option>
<option value="AV"></option>
<option value="BA"></option>
<option value="BT"></option>
<option value="BL"></option>
<option value="BN"></option>
<option value="BG"></option>
<option value="BI"></option>
<option value="BO"></option>
<option value="BZ"></option>
<option value="BS"></option>
<option value="BR"></option>
<option value="CA"></option>
<option value="CL"></option>
<option value="CB"></option>
<option value="CE"></option>
<option value="CT"></option>
<option value="CZ"></option>
<option value="CH"></option>
<option value="CO"></option>
<option value="CS"></option>
<option value="CR"></option>
<option value="KR"></option>
<option value="CN"></option>
<option value="EN"></option>
<option value="FM"></option>
<option value="FE"></option>
<option value="FI"></option>
<option value="FG"></option>
<option value="FC"></option>
<option value="FR"></option>
<option value="GE"></option>
<option value="GO"></option>
<option value="GR"></option>
<option value="IM"></option>
<option value="IS"></option>
<option value="SP"></option>
<option value="LT"></option>
<option value="LE"></option>
<option value="LC"></option>
<option value="LI"></option>
<option value="LO"></option>
<option value="LU"></option>
<option value="MC"></option>
<option value="MN"></option>
<option value="MS"></option>
<option value="MT"></option>
<option value="ME"></option>
<option value="MI"></option>
<option value="MO"></option>
<option value="MB"></option>
<option value="NA"></option>
<option value="NO"></option>
<option value="NU"></option>
<option value="OR"></option>
<option value="PD"></option>
<option value="PA"></option>
<option value="PR"></option>
<option value="PV"></option>
<option value="PG"></option>
<option value="PU"></option>
<option value="PI"></option>
<option value="PT"></option>
<option value="PN"></option>
<option value="PZ"></option>
<option value="PO"></option>
<option value="RG"></option>
<option value="RA"></option>
<option value="RC"></option>
<option value="RE"></option>
<option value="RI"></option>
<option value="RN"></option>
<option value="RM"></option>
<option value="RO"></option>
<option value="SA"></option>
<option value="SS"></option>
<option value="SV"></option>
<option value="SI"></option>
<option value="SR"></option>
<option value="SO"></option>
<option value="TA"></option>
<option value="TE"></option>
<option value="TR"></option>
<option value="TO"></option>
<option value="TP"></option>
<option value="TN"></option>
<option value="TV"></option>
<option value="TS"></option>
<option value="UD"></option>
<option value="VA"></option>
<option value="VE"></option>
<option value="VB"></option>
<option value="VC"></option>
<option value="VR"></option>
<option value="VV"></option>
<option value="VI"></option>
<option value="VT"></option>
<option value="SU"></option>
</datalist>

<style id="cnp_appunti_2025-09-03">
  #cardTrasferte .name.note-active {
    color: #f59e0b !important;
    text-decoration: underline;
    text-decoration-thickness: 3px;
    text-underline-offset: 3px;
  }
  #cardTrasferte .name .appunto {
    margin-left: 8px;
    font-size: .95em;
    font-style: italic;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(245,158,11,.15);
    border: 1px solid rgba(245,158,11,.45);
    color: #ffedd5;
    white-space: pre-wrap;
  }
</style>


<style id="cnp_appunti_print_2025-09-03">
@media print {
  #cardTrasferte .name.note-active {
    color: #000 !important;
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }
  #cardTrasferte .name .appunto {
    background: none !important;
    border: none !important;
    color: #000 !important;
    padding: 0 !important;
    font-style: normal;
  }
  #cardTrasferte .name .appunto::before {
    content: " — Appunto: ";
    font-weight: 600;
  }
  #cardTrasferte * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
</style>


<style id="cnp_gender_override_trasferte_2025-09-03">
/* Disabilita la colorazione per genere SOLO nella lista Trasferte */
#cardTrasferte .female, 
#cardTrasferte .gender-female,
#cardTrasferte .gender-f,
#cardTrasferte .woman,
#cardTrasferte .donna {
  color: inherit !important;
  background: inherit !important;
  border-color: inherit !important;
  filter: none !important;
}
#cardTrasferte .name .tag.female,
#cardTrasferte .badge.female,
#cardTrasferte .pill.female,
#cardTrasferte .chip.female {
  background: var(--accent, #3b82f6) !important; /* usa colore standard */
  color: white !important;
  border-color: transparent !important;
}
/* Se il nome veniva colorato con :has(.female) o simili, neutralizza */
#cardTrasferte .name { color: inherit !important; }
</style>


<!-- Firebase + Cloud Sync with Config Helper -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
(function(){
  // 1) CONFIG HELPER ---------------------------------------------------------
  // Default config (può essere sbagliata; se non funziona, chiediamo di incollarne una corretta)
  var DEFAULT_CONFIG = {
    apiKey: "AIzaSyBfBR_YNt-kTFoa-SAFbWk15UoS1a1X03k",
    authDomain: "club-napoli-modena.firebaseapp.com",
    projectId: "club-napoli-modena",
    storageBucket: "club-napoli-modena.firebasestorage.app",
    messagingSenderId: "143536134939",
    appId: "1:143536134939:web:8a0086b0b05a6a916df51be"
  };

  function parseMaybeJSON(txt){
    try{ return JSON.parse(txt); }catch(_){ return null; }
  }

  // Leggi eventuale config salvata localmente
  var saved = localStorage.getItem('firebaseConfigJSON');
  var cfg = saved ? parseMaybeJSON(saved) : null;
  if(!cfg || !cfg.apiKey){
    cfg = DEFAULT_CONFIG;
  }
  window._firebaseConfig = cfg;

  // UI badge (usa i chip esistenti "Offline"/"Connesso" + ne aggiunge uno se manca)
  function paintAll(status){
    var chips = Array.from(document.querySelectorAll('.chip, span'));
    var touched = false;
    chips.forEach(function(el){
      var t = (el.textContent||'').trim().toLowerCase();
      if(t==='offline' || t==='connesso'){
        el.textContent = status ? 'Connesso' : 'Offline';
        el.style.background = status ? '#065f46' : '#334155';
        el.style.color = status ? '#d1fae5' : '#e5e7eb';
        el.style.borderColor = status ? '#10b981' : '#475569';
        touched = true;
      }
    });
    if(!touched){
      var b = document.createElement('span');
      b.textContent = status ? 'Connesso' : 'Offline';
      b.className = 'chip';
      b.style.marginLeft = '6px';
      b.style.background = status ? '#065f46' : '#334155';
      b.style.color = status ? '#d1fae5' : '#e5e7eb';
      b.style.border = '1px solid ' + (status ? '#10b981' : '#475569');
      (document.querySelector('.toolbar')||document.body).appendChild(b);
    }
  }

  function askForConfigAndReload(message){
    var txt = prompt((message||'') + '\n\nIncolla qui l’oggetto di configurazione Firebase (da { a }):');
    if(!txt){ return; }
    // Permette incollare direttamente l'oggetto senza JSON.stringify
    // Proviamo a trasformarlo in JSON valido
    try{
      // Sostituisci chiavi non tra virgolette con virgolette (grezzo ma utile)
      var fixed = txt.trim();
      // se inizia con 'const firebaseConfig = {', estrai solo { ... }
      var m = fixed.match(/\{[\s\S]*\}$/);
      if(m) fixed = m[0];
      // Converte in JSON grezzo: metti doppi apici sulle chiavi se mancanti
      fixed = fixed.replace(/(\w+)\s*:/g, '"$1":');
      var obj = JSON.parse(fixed);
      if(!obj.apiKey){ alert('Config non valida: manca apiKey'); return; }
      localStorage.setItem('firebaseConfigJSON', JSON.stringify(obj));
      alert('Config salvata. La pagina verrà ricaricata.');
      location.reload();
    }catch(e){
      console.error(e);
      alert('Config non valida. Assicurati di incollare l’oggetto completo { apiKey: "...", ... }');
    }
  }

  // 2) INIT + SYNC -----------------------------------------------------------
  const FIRE_COLLECTION = 'clubs';
  const FIRE_DOC_ID = 'club-napoli-modena';
  paintAll(false);

  function start(){
    const db = firebase.firestore();
    // signin anonimo
    firebase.auth().signInAnonymously().then(function(){
      paintAll(true);
      runSync(db);
    }).catch(function(err){
      console.warn('Auth anonima errore:', err);
      paintAll(false);
      if(String(err && err.code).includes('api-key')){
        askForConfigAndReload('La apiKey non è valida.');
      }
      // altri errori verranno solo mostrati sulla console
    });
  }

  function runSync(db){
    let lastLocalWriteTs = 0, applyingRemote = false;
    function now(){ return Date.now(); }
    function getPayload(){
      try{
        const state = JSON.parse(localStorage.getItem('club-napoli-db-v1')||'{}');
        const titles = JSON.parse(localStorage.getItem('club-napoli-titles')||'{}');
        const logo = localStorage.getItem('club-napoli-logo')||null;
        const trasfTitle = localStorage.getItem('trasferte-title')||'';
        return { state, titles, logo, trasferta_title: trasfTitle };
      }catch(_){ return {}; }
    }
    function apply(pl){
      try{
        if(!pl) return;
        applyingRemote = true;
        if(pl.state) localStorage.setItem('club-napoli-db-v1', JSON.stringify(pl.state));
        if(pl.titles) localStorage.setItem('club-napoli-titles', JSON.stringify(pl.titles));
        if(pl.logo!=null) localStorage.setItem('club-napoli-logo', pl.logo);
        if(pl.trasferta_title!=null) localStorage.setItem('trasferte-title', pl.trasferta_title);
        if(typeof renderAll === 'function'){ renderAll(); } else { location.reload(); }
      } finally { applyingRemote = false; }
    }

    const ref = db.collection(FIRE_COLLECTION).doc(FIRE_DOC_ID);

    ref.onSnapshot(function(snap){
      if(!snap.exists) return;
      const data = snap.data();
      if(data._lastWriteTs && data._lastWriteTs === lastLocalWriteTs){ return; }
      apply(data);
    });

    const oldSave = (typeof window.save === 'function') ? window.save : null;
    window.save = function(){
      if(oldSave) oldSave();
      if(applyingRemote) return;
      const payload = getPayload();
      lastLocalWriteTs = now();
      ref.set({ ...payload, _lastWriteTs: lastLocalWriteTs }, { merge: true })
         .catch(function(e){ console.error('Sync up error', e); });
    };

    ref.get().then(function(snap){
      if(!snap.exists){
        const payload = getPayload();
        lastLocalWriteTs = now();
        return ref.set({ ...payload, _lastWriteTs: lastLocalWriteTs });
      }
    });
  }

  try {
    firebase.initializeApp(window._firebaseConfig);
    start();
  } catch(e){
    console.warn('Init error:', e);
    if(String(e && e.message).toLowerCase().includes('api-key')){
      askForConfigAndReload('La apiKey non è valida.');
    }
  }
})();
</script>

</body>
</html>
